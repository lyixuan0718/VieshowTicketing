<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚ç¥¨æ­¥é©Ÿ 1: é¸é›»å½±/å ´æ¬¡/åœ°é» - Vieshow Ticketing</title> 
    
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // Tailwind é…ç½®ï¼Œç¢ºä¿é¡è‰²å’Œå­—é«”èˆ‡å°ˆæ¡ˆä¸€è‡´
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        /* åŸºç¤é¸æ“‡æ¡†æ¨£å¼ */
        .select-styled {
            @apply w-full p-3 bg-white border border-gray-300 rounded-lg shadow-sm
                   focus:outline-none focus:ring-2 focus:ring-vieshow-gold focus:border-vieshow-gold;
        }
        /* ä¸‹ä¸€æ­¥æŒ‰éˆ•çš„ Vieshow ç´…è‰²é¢¨æ ¼ */
        .next-step-button {
            @apply w-full bg-vieshow-red hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl 
                   transition duration-300 shadow-lg mt-8 text-lg disabled:opacity-50 disabled:cursor-not-allowed;
        }
        /* è¼‰å…¥è¨Šæ¯æ¨£å¼ */
        .loading-message {
            @apply text-center text-base text-gray-500 mt-4 italic;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">
    
    <!-- Header å°èˆª (æ¨¡æ“¬å…±ç”¨ header) -->
    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <!-- ç¢ºä¿é¦–é é€£çµæ­£ç¢º -->
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div class="space-x-4">
                <a href="../auth/login.html" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a>
                <a href="../member/member_home.html" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
            </div>
        </nav>
    </header>

    <div class="container mx-auto px-4 py-8 flex-grow max-w-2xl">
        
        <!-- ä¸»è¦è¨‚ç¥¨å¡ç‰‡ (åŒ…å«æ­¥é©ŸæŒ‡ç¤ºèˆ‡è¡¨å–®ï¼Œåˆä½µç‚ºä¸€å€‹æ¡†æ¡†) -->
        <div id="bookingCard" class="bg-white p-6 md:p-10 rounded-xl shadow-2xl border-t-4 border-vieshow-red">
            
            <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ (æ‚¨çš„ (1) å€å¡Š) -->
            <div class="mb-8 pb-4 border-b border-gray-200">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">ğŸŸï¸ è¨‚ç¥¨æµç¨‹</h1>
                <p class="text-xl font-semibold text-vieshow-red">æ­¥é©Ÿ 1/7: é¸æ“‡å ´æ¬¡</p>
                <p class="text-sm text-gray-500 mt-1">è«‹ä¾åºé¸æ“‡å½±åŸã€é›»å½±ï¼Œæœ€å¾Œç¢ºèªå ´æ¬¡ã€‚</p>
            </div>

            <!-- è¡¨å–®å€å¡Š (æ‚¨çš„ (2) å€å¡Š) -->
            <form id="bookingFlow1Form" action="#" method="POST" class="space-y-6">
                
                <!-- 1. é¸æ“‡å½±åŸåœ°é» -->
                <div>
                    <label for="cinema_location" class="block text-2xl font-bold text-gray-800 mb-4 border-b pb-2">1. å½±åŸåœ°é»:</label>
                    <select id="cinema_location" name="cinema_location" required class="select-styled">
                        <option value="" disabled selected>è«‹é¸æ“‡å½±åŸåœ°é»</option>
                        <!-- Options filled by JavaScript -->
                    </select>
                </div>
                
                <!-- 2. é¸æ“‡é›»å½± -->
                <div>
                    <label for="movie_select" class="block text-2xl font-bold text-gray-800 mb-4 border-b pb-2">2. é¸æ“‡é›»å½±:</label>
                    <select id="movie_select" name="movie_id" required disabled class="select-styled">
                        <option value="" disabled selected>è«‹å…ˆé¸æ“‡å½±åŸåœ°é»</option>
                    </select>
                </div>
                
                <!-- 3. é¸æ“‡å ´æ¬¡ -->
                <div>
                    <label for="showtime_select" class="block text-2xl font-bold text-gray-800 mb-4 border-b pb-2">3. é¸æ“‡å ´æ¬¡ (æ—¥æœŸ/æ™‚é–“/å½±å»³):</label>
                    <select id="showtime_select" name="showtime_id" required disabled class="select-styled">
                        <option value="" disabled selected>è«‹å…ˆé¸æ“‡é›»å½±</option>
                    </select>
                </div>
                
                <!-- è¼‰å…¥ç‹€æ…‹è¨Šæ¯ -->
                <div id="loadingStatus" class="loading-message">è¼‰å…¥ä¸­...</div>

                <!-- ä¸‹ä¸€æ­¥æŒ‰éˆ• -->
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        <button type="submit" id="nextStepButton" class="next-step-button flex-1" disabled style="border: 2px solid #333; border-radius: 6px;">
                            ä¸‹ä¸€æ­¥: é¸æ“‡ç¥¨ç¨®èˆ‡é¤é» (æ­¥é©Ÿ 2)
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- è¨‚ç¥¨é é¢å°ˆå±¬çš„ JavaScript é‚è¼¯ï¼šå‹•æ…‹è¼‰å…¥è³‡æ–™ä¸¦è™•ç†è¡¨å–® -->
    <script>
        // è¨­å®šæœªä¾† FastAPI å¾Œç«¯ API çš„åŸºç¤ URL (æš«æ™‚ä¸éœ€è¦ï¼Œæ”¹ç”¨ Mock Data)
        // const API_BASE_URL = 'https://your-fastapi-backend.com/api/v1'; 

        // å–å¾— DOM å…ƒç´ 
        const cinemaSelect = document.getElementById('cinema_location');
        const movieSelect = document.getElementById('movie_select');
        const showtimeSelect = document.getElementById('showtime_select');
        const nextButton = document.querySelector('.next-step-button');
        const loadingStatus = document.getElementById('loadingStatus');
        const form = document.getElementById('bookingFlow1Form');

        // æ­¥é©Ÿ 1: å‹•æ…‹è¼‰å…¥å½±åŸåœ°é» (ä½¿ç”¨ Mock Data)
        async function loadCinemas() {
            try {
                loadingStatus.textContent = 'æ­£åœ¨è¼‰å…¥å½±åŸåœ°é»...';
                
                // --- ä¿®æ­£è™•ï¼šä½¿ç”¨æ¨¡æ“¬è³‡æ–™å–ä»£ fetch API å‘¼å« ---
                const mockResponse = {
                    cinemas: [
                        { id: 'taipei_xinyi', name: 'å°åŒ—ä¿¡ç¾©' },
                        { id: 'taoyuan_tzyyuan', name: 'æ¡ƒåœ’çµ±é ˜' },
                        { id: 'taichung_wenxin', name: 'å°ä¸­æ–‡å¿ƒ' }
                    ]
                };
                
                // æ¨¡æ“¬ç¶²è·¯å»¶é²
                await new Promise(resolve => setTimeout(resolve, 300));
                const data = mockResponse; 
                // --------------------------------------------------
                
                // æ¸…ç©ºä¸¦å¡«å……å½±åŸä¸‹æ‹‰å¼é¸å–®
                cinemaSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å½±åŸåœ°é»</option>';
                data.cinemas.forEach(cinema => {
                    const option = document.createElement('option');
                    option.value = cinema.id;
                    option.textContent = cinema.name;
                    cinemaSelect.appendChild(option);
                });

                cinemaSelect.disabled = false;
                loadingStatus.textContent = ''; // æ¸…é™¤è¼‰å…¥ç‹€æ…‹
            } catch (error) {
                console.error('è¼‰å…¥å½±åŸå¤±æ•—:', error);
                loadingStatus.textContent = 'è¼‰å…¥å½±åŸè³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚';
            }
        }

        // æ­¥é©Ÿ 2: æ ¹æ“šé¸æ“‡çš„å½±åŸï¼Œå‹•æ…‹è¼‰å…¥é›»å½±æ¸…å–® (ä½¿ç”¨ Mock Data)
        async function loadMovies(cinemaId) {
            movieSelect.innerHTML = '<option value="" disabled selected>æ­£åœ¨è¼‰å…¥é›»å½±...</option>';
            movieSelect.disabled = true;
            showtimeSelect.innerHTML = '<option value="" disabled selected>è«‹å…ˆé¸æ“‡é›»å½±</option>';
            showtimeSelect.disabled = true;
            nextButton.disabled = true;

            try {
                // --- ä¿®æ­£è™•ï¼šä½¿ç”¨æ¨¡æ“¬è³‡æ–™å–ä»£ fetch API å‘¼å« ---
                await new Promise(resolve => setTimeout(resolve, 300));
                
                let movies = [];
                if (cinemaId === 'taipei_xinyi') {
                    movies = [
                        { id: 1, title: 'é˜¿å‡¡é” 3: æœ€çµ‚æˆ°å½¹' },
                        { id: 2, title: 'ä¸å¯èƒ½çš„ä»»å‹™ 8' }
                    ];
                } else if (cinemaId === 'taoyuan_tzyyuan') {
                    movies = [
                        { id: 1, title: 'é˜¿å‡¡é” 3: æœ€çµ‚æˆ°å½¹' },
                        { id: 3, title: 'é§­å®¢ä»»å‹™ 5' }
                    ];
                } else {
                    movies = [{ id: 4, title: 'ç¥ç§˜é›»å½±' }];
                }
                
                const data = { movies: movies };
                // --------------------------------------------------
                
                // æ¸…ç©ºä¸¦å¡«å……é›»å½±ä¸‹æ‹‰å¼é¸å–®
                movieSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡é›»å½±</option>';
                data.movies.forEach(movie => {
                    const option = document.createElement('option');
                    option.value = movie.id;
                    option.textContent = movie.title;
                    movieSelect.appendChild(option);
                });

                movieSelect.disabled = false;
            } catch (error) {
                console.error('è¼‰å…¥é›»å½±å¤±æ•—:', error);
                movieSelect.innerHTML = '<option value="" disabled selected>è¼‰å…¥é›»å½±æ¸…å–®å¤±æ•—</option>';
            }
        }

        // æ­¥é©Ÿ 3: æ ¹æ“šé¸æ“‡çš„å½±åŸå’Œé›»å½±ï¼Œå‹•æ…‹è¼‰å…¥å ´æ¬¡æ¸…å–® (ä½¿ç”¨ Mock Data)
        async function loadShowtimes(cinemaId, movieId) {
            showtimeSelect.innerHTML = '<option value="" disabled selected>æ­£åœ¨è¼‰å…¥å ´æ¬¡...</option>';
            showtimeSelect.disabled = true;
            nextButton.disabled = true;

            try {
                // --- ä¿®æ­£è™•ï¼šä½¿ç”¨æ¨¡æ“¬è³‡æ–™å–ä»£ fetch API å‘¼å« ---
                await new Promise(resolve => setTimeout(resolve, 300));
                
                let showtimes = [];
                if (movieId == 1) { // é˜¿å‡¡é” 3
                    showtimes = [
                        { id: 101, date: '2025/12/24(ä¸‰)', time: '19:30', hall: 'å·¨å¹•å»³' },
                        { id: 102, date: '2025/12/24(ä¸‰)', time: '22:00', hall: 'æ¨™æº–å»³' }
                    ];
                } else if (movieId == 2) { // ä¸å¯èƒ½çš„ä»»å‹™ 8
                    showtimes = [
                        { id: 201, date: '2025/12/25(å››)', time: '14:00', hall: 'æ¨™æº–å»³' }
                    ];
                } else {
                    showtimes = [];
                }
                
                const data = { showtimes: showtimes };
                // --------------------------------------------------

                // æ¸…ç©ºä¸¦å¡«å……å ´æ¬¡ä¸‹æ‹‰å¼é¸å–®
                showtimeSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å ´æ¬¡ (æ—¥æœŸ/æ™‚é–“/å½±å»³)</option>';
                if (data.showtimes.length === 0) {
                    showtimeSelect.innerHTML = '<option value="" disabled selected>æ­¤æ™‚æ®µç„¡å ´æ¬¡</option>';
                } else {
                    data.showtimes.forEach(showtime => {
                        const option = document.createElement('option');
                        option.value = showtime.id;
                        option.textContent = `${showtime.date} ${showtime.time} - ${showtime.hall}`;
                        showtimeSelect.appendChild(option);
                    });
                }
                
                showtimeSelect.disabled = false;
            } catch (error) {
                console.error('è¼‰å…¥å ´æ¬¡å¤±æ•—:', error);
                showtimeSelect.innerHTML = '<option value="" disabled selected>è¼‰å…¥å ´æ¬¡æ¸…å–®å¤±æ•—</option>';
            }
        }
        
        // ç›£è½å™¨ï¼šå½±åŸé¸æ“‡æ”¹è®Šæ™‚
        cinemaSelect.addEventListener('change', function() {
            const cinemaId = this.value;
            if (cinemaId) {
                loadMovies(cinemaId);
            }
        });

        // ç›£è½å™¨ï¼šé›»å½±é¸æ“‡æ”¹è®Šæ™‚
        movieSelect.addEventListener('change', function() {
            const cinemaId = cinemaSelect.value;
            const movieId = this.value;
            if (cinemaId && movieId) {
                loadShowtimes(cinemaId, movieId);
            }
        });

        // ç›£è½å™¨ï¼šå ´æ¬¡é¸æ“‡æ”¹è®Šæ™‚
        showtimeSelect.addEventListener('change', function() {
            // åªè¦é¸å®šäº†å ´æ¬¡ï¼Œå°±å•Ÿç”¨ä¸‹ä¸€æ­¥æŒ‰éˆ•
            nextButton.disabled = !this.value;
        });
        
        // ç›£è½å™¨ï¼šè¡¨å–®æäº¤ (ä¸‹ä¸€æ­¥)
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            // å„²å­˜ä½¿ç”¨è€…é¸æ“‡çš„è³‡è¨Šï¼Œä»¥ä¾¿åœ¨æ­¥é©Ÿ 2/7 ä¸­ä½¿ç”¨
            const bookingData = {
                cinemaId: cinemaSelect.value,
                movieId: movieSelect.value,
                showtimeId: showtimeSelect.value,
                // å„²å­˜é¡¯ç¤ºåç¨±
                cinemaName: cinemaSelect.options[cinemaSelect.selectedIndex].textContent,
                movieTitle: movieSelect.options[movieSelect.selectedIndex].textContent,
                showtimeDetail: showtimeSelect.options[showtimeSelect.selectedIndex].textContent,
            };
            
            // ç”±æ–¼é€™æ˜¯ç´”å‰ç«¯ï¼Œæˆ‘å€‘å°‡è³‡æ–™å­˜åœ¨ localStorage (å¯¦éš›å°ˆæ¡ˆæ‡‰å­˜åœ¨ Session æˆ– Context)
            localStorage.setItem('currentBooking', JSON.stringify(bookingData));
            
            console.log('å·²å„²å­˜è¨‚ç¥¨æ­¥é©Ÿ 1 è³‡æ–™:', bookingData);
            
            // è·³è½‰åˆ°æ­¥é©Ÿ 2 é é¢
            window.location.href = 'booking_flow_2.html';
        });

        // é é¢è¼‰å…¥æ™‚ï¼ŒåŸ·è¡Œç¬¬ä¸€æ¬¡å½±åŸè³‡æ–™è¼‰å…¥
        window.onload = loadCinemas;
    </script>


    <!-- Footer å…§å®¹ (æ¨¡æ“¬å…±ç”¨ footer) -->
    <footer class="bg-gray-800 text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>
    
</body>
</html>