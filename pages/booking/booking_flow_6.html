<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚ç¥¨æ­¥é©Ÿ 6: å¡«å¯«ä»˜æ¬¾è³‡è¨Š - Vieshow Ticketing</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* èˆ‡ Step5 ä¸€è‡´çš„æŒ‰éˆ• */
        .next-step-button, .pay-now-button {
            width: 100%;
            background-color: #e50914;
            color: white;
            padding: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 10px;
            transition: 0.2s;
            margin-top: 18px;
        }
        .next-step-button:hover, .pay-now-button:hover {
            background-color: #b00710;
        }

        .error-message {
            color: red;
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
        }

        .payment-info-section input {
            width: 100%;
            padding: 10px;
            border: 1px solid #bbb;
            border-radius: 8px;
            margin-bottom: 14px;
        }

        .row-group {
            display: flex;
            gap: 10px;
        }

        .row-group div {
            flex: 1;
        }
    </style>
</head>

<body class="antialiased">

<!-- Header -->
<header class="bg-gray-800 text-white shadow-md">
    <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
        <a href="../../index.html" class="text-xl font-bold hover:text-red-400 transition">Vieshow å½±åŸ</a>
        <div class="space-x-4">
            <a href="../auth/login.html" class="hover:text-yellow-300 transition">ç™»å…¥</a>
            <a href="../member/member_home.html" class="hover:text-yellow-300 transition">æœƒå“¡ä¸­å¿ƒ</a>
        </div>
    </nav>
</header>

<!-- Container -->
<div class="w-11/12 md:max-w-2xl mx-auto my-8 p-6 bg-white border border-gray-200 rounded-xl shadow-2xl">

    <h2 class="text-2xl font-extrabold text-gray-900 mb-6 flex items-center">
        ğŸ§¾ è¨‚ç¥¨æµç¨‹ - æ­¥é©Ÿ 6/7 (å¡«å¯«ä»˜æ¬¾è³‡è¨Š)
    </h2>

    <p class="text-gray-700 mb-4">
        è«‹è¼¸å…¥æ‚¨çš„ä»˜æ¬¾è³‡è¨Šï¼Œä¸¦æœ€çµ‚ç¢ºèªè¨‚å–®ã€‚
    </p>

    <form id="paymentDetailForm">

        <!-- ä»˜æ¬¾æ–¹å¼å±•ç¤º -->
        <h3 class="font-semibold">ä»˜æ¬¾æ–¹å¼ï¼š
            <span id="displayPaymentMethod" class="text-red-600 font-bold">è¼‰å…¥ä¸­...</span>
        </h3>

        <div id="paymentFields" class="payment-info-section mt-3">
            <!-- JS å‹•æ…‹æ³¨å…¥ -->
        </div>

        <h3 class="mt-4 text-lg font-bold">
            æœ€çµ‚é‡‘é¡ï¼š<span class="text-red-600 text-2xl">NT$ <span id="displayTotalAmount">0</span></span>
        </h3>

        <p id="errorMessage" class="error-message">è«‹å¡«å¯«å¿…å¡«æ¬„ä½</p>

        <button type="submit" class="pay-now-button">ç¢ºèªä»˜æ¬¾ä¸¦é€å‡ºè¨‚å–®</button>
    </form>

    <p class="mt-4 text-center">
        <a href="#" id="backLink" class="text-red-600 hover:text-red-800">
            â† è¿”å›ä¸Šä¸€æ­¥ (é¸æ“‡ä»˜æ¬¾æ–¹å¼)
        </a>
    </p>

</div>

<!-- JS -->
<script>
    function safeNavigate(fileName) {
        try {
            window.location.href = fileName;
        } catch (e) {
            const currentPath = window.location.href;
            const dirPath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
            window.location.href = dirPath + fileName;
        }
    }

    let currentBooking = {};

    // å‹•æ…‹ç”¢ç”Ÿä¿¡ç”¨å¡/LinePay æ¬„ä½
    function renderPaymentFields(method) {
        const fields = document.getElementById("paymentFields");
        fields.innerHTML = "";

        if (method === "credit_card") {
            document.getElementById("displayPaymentMethod").textContent = "ä¿¡ç”¨å¡/é‡‘èå¡";

            fields.innerHTML = `
                <label>æŒå¡äººå§“å</label>
                <input type="text" id="card_name" required placeholder="å§“å">

                <label>ä¿¡ç”¨å¡è™Ÿ</label>
                <input type="text" id="card_number" required maxlength="16" placeholder="xxxx xxxx xxxx xxxx">

                <div class="row-group">
                    <div>
                        <label>æœ‰æ•ˆæœŸé™ (MM/YY)</label>
                        <input type="text" id="expiry_date" required maxlength="5" placeholder="MM/YY">
                    </div>
                    <div>
                        <label>å®‰å…¨ç¢¼ CVV</label>
                        <input type="text" id="cvv" required maxlength="3" placeholder="ä¸‰ç¢¼">
                    </div>
                </div>
            `;
        }

        if (method === "line_pay") {
            document.getElementById("displayPaymentMethod").textContent = "Line Pay";

            fields.innerHTML = `
                <p>æ‚¨å°‡è¢«å°å‘ Line Pay é€²è¡Œä»˜æ¬¾æˆæ¬Š</p>

                <label>ä¿¡ç®± (æ¥æ”¶ä»˜æ¬¾é€šçŸ¥)</label>
                <input type="email" id="email" required placeholder="example@mail.com">
            `;
        }
    }

    // è®€å–è³‡æ–™
    function loadBookingData() {
        const stored = localStorage.getItem("currentBooking");

        if (!stored) {
            console.warn("æ²’æœ‰ currentBooking â†’ è¿”å› Step5");
            safeNavigate("booking_flow_5.html");
            return;
        }

        try {
            currentBooking = JSON.parse(stored);
        } catch (e) {
            safeNavigate("booking_flow_5.html");
            return;
        }

        // âš  ä¿®æ­£ï¼šä¸èƒ½ç”¨ !totalPriceï¼ˆ0 æœƒè¢«èª¤åˆ¤ï¼‰
        if (currentBooking.totalPrice == null || !currentBooking.payment_method) {
            console.error("è³‡æ–™ä¸å®Œæ•´ â†’ è¿”å› Step5");
            safeNavigate("booking_flow_5.html");
            return;
        }

        document.getElementById("displayTotalAmount").textContent = currentBooking.totalPrice;

        // æ¸²æŸ“æ¬„ä½
        renderPaymentFields(currentBooking.payment_method);
    }

    // æäº¤ä»˜æ¬¾
    document.getElementById("paymentDetailForm").addEventListener("submit", function (e) {
        e.preventDefault();

        if (!this.checkValidity()) {
            document.getElementById("errorMessage").style.display = "block";
            return;
        }

        // æ¨¡æ“¬ä»˜æ¬¾æˆåŠŸ
        currentBooking.status = "COMPLETED";
        localStorage.setItem("lastCompletedBooking", JSON.stringify(currentBooking));
        localStorage.removeItem("currentBooking");

        safeNavigate("booking_result.html?status=success");
    });

    // è¿”å›ä¸Šä¸€é 
    document.getElementById("backLink").addEventListener("click", function (e) {
        e.preventDefault();
        safeNavigate("booking_flow_5.html");
    });

    loadBookingData();
</script>

<footer class="bg-gray-800 text-white text-center py-4 mt-8 shadow-inner">
    <p>&copy; 2025 Vieshow Ticketing System</p>
</footer>

</body>
</html>
