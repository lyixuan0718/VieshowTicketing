<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚ç¥¨æ­¥é©Ÿ 3: é¸æ“‡åº§ä½ - Vieshow Ticketing</title> 
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .seat {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: 0.15s;
        }
        .available { background-color: #22c55e; } /* ç¶ è‰² */
        .available:hover { background-color: #16a34a; } 
        .occupied { background-color: #9ca3af; cursor: not-allowed; }
        .selected { background-color: #dc2626; transform: scale(1.07); }
    </style>

</head>
<body class="antialiased">

<!-- Header -->
<header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div class="space-x-4">
                <a href="../auth/login.html" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a>
                <a href="../member/member_home.html" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
            </div>
        </nav>
    </header>

<!-- ä¸»å®¹å™¨ -->
<div class="w-11/12 md:max-w-2xl mx-auto my-8 p-6 bg-white border border-gray-200 rounded-xl shadow-2xl">

    <h2 class="text-2xl font-extrabold text-gray-900 mb-6 flex items-center">
        ğŸ« è¨‚ç¥¨é¸ä½ - æ­¥é©Ÿ 3/7 (é¸æ“‡åº§ä½)
    </h2>

    <!-- é›»å½±è³‡è¨Š -->
    <div class="bg-gray-50 p-4 rounded-lg mb-6 text-sm md:text-base border border-gray-100">
        <p>å½±åŸï¼š<strong id="cinemaName">è¼‰å…¥ä¸­...</strong></p>
        <p>é›»å½±ï¼š<strong id="movieTitle">è¼‰å…¥ä¸­...</strong></p>
        <p>å ´æ¬¡ï¼š<strong id="showtimeDetails">è¼‰å…¥ä¸­...</strong></p>
    </div>

    <!-- åº§ä½é¸æ“‡æ¨™é¡Œ -->
    <h3 class="text-xl font-semibold border-b-2 border-red-600 pb-2 text-red-700">
        è«‹é¸æ“‡åº§ä½ï¼ˆ<span id="requiredTickets">0</span> å¼µï¼‰
    </h3>

    <!-- åœ–ä¾‹ -->
    <div class="flex space-x-6 mt-4 mb-4 text-sm text-gray-700">
        <div class="flex items-center"><div class="w-4 h-4 bg-green-400 mr-2 rounded"></div>å¯é¸</div>
        <div class="flex items-center"><div class="w-4 h-4 bg-gray-400 mr-2 rounded"></div>å·²å”®</div>
        <div class="flex items-center"><div class="w-4 h-4 bg-red-600 mr-2 rounded"></div>å·²é¸</div>
    </div>

    <!-- åº§ä½åœ°åœ– -->
    <div class="bg-gray-100 p-4 rounded-lg border">
        <div class="bg-gray-800 text-white text-center py-2 mb-4 rounded font-bold">
            --- å½±å»³è¢å¹• ---
        </div>
        <div id="seatMap" class="flex flex-col space-y-2"></div>
    </div>

    <!-- å·²é¸åº§ä½ -->
    <div class="mt-6">
        <h4 class="font-semibold">å·²é¸åº§ä½ï¼š</h4>
        <p id="selectedSeatsDisplay" class="text-xl text-red-600 font-bold">ç„¡</p>
    </div>

    <div id="errorMessage" class="font-bold mt-4 text-center text-red-600"></div>

    <!-- è¨‚å–®æ‘˜è¦ -->
    <h3 class="text-xl font-semibold border-b-2 border-red-600 pb-2 mt-8 mb-4 text-red-700">
        æ‚¨çš„è¨‚å–®æ‘˜è¦
    </h3>

    <div class="bg-gray-50 p-4 rounded-lg mb-6 text-sm md:text-base border border-gray-100">
        <p>æ‡‰é¸å¼µæ•¸ï¼š<strong id="totalTicketsRequired" class="text-red-700">0</strong> å¼µ</p>
        <p>å·²é¸åº§ä½ï¼š<strong id="selectedSeatsSummary" class="text-red-700">ç„¡</strong></p>

        <div class="border-t mt-2 pt-2">
            <p id="ticketsSummary">ç¥¨ç¨®èˆ‡æ•¸é‡ï¼šè¼‰å…¥ä¸­...</p>
            <p id="foodSummary">é¤é»ï¼šè¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- è¡¨å–® -->
    <form id="bookingFlow3Form">
        <input type="hidden" name="selected_seats" id="submitSeats" value="">

        <button type="submit" class="w-full py-3 bg-red-700 text-white rounded-lg font-bold text-lg hover:bg-red-800 transition disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
            ä¸‹ä¸€æ­¥ï¼šè¨‚å–®ç¢ºèª (æ­¥é©Ÿ 4)
        </button>
    </form>

    <p class="mt-4 text-center">
        <a href="booking_flow_2.html" class="text-red-600 hover:text-red-800">â† è¿”å›ä¸Šä¸€æ­¥</a>
    </p>
</div>

<!-- JSï¼šæ•´åˆå¾Œå”¯ä¸€ç‰ˆæœ¬ -->
<script>
    let currentBooking = {};
    let totalTickets = 0;
    let selectedSeats = [];

    const cinemaNameDisplay = document.getElementById("cinemaName");
    const movieTitleDisplay = document.getElementById("movieTitle");
    const showtimeDetailDisplay = document.getElementById("showtimeDetails");

    const requiredTicketsSpan = document.getElementById("requiredTickets");
    const totalTicketsRequiredSpan = document.getElementById("totalTicketsRequired");

    const selectedSeatsDisplay = document.getElementById("selectedSeatsDisplay");
    const selectedSeatsSummary = document.getElementById("selectedSeatsSummary");

    const ticketsSummary = document.getElementById("ticketsSummary");
    const foodSummary = document.getElementById("foodSummary");

    const submitSeatsInput = document.getElementById("submitSeats");
    const nextButton = document.querySelector("button[type='submit']");
    const errorMessage = document.getElementById("errorMessage");

    // Mock åº§ä½ï¼ˆA=å¯é¸ / O=å·²å”®ï¼‰
    const seatData = [
        ["A","A","A","O","A","A","A","A","A","A"],
        ["O","A","A","A","A","A","O","A","A","A"],
        ["A","A","A","A","A","A","A","O","A","A"],
        ["A","A","O","A","A","A","A","A","A","A"],
        ["A","A","A","A","A","A","A","A","A","A"],
    ];
    const rows = ["A","B","C","D","E"];

    function loadBookingData() {
    // è®€ Step1/Step2 çš„è³‡æ–™
    const stored = localStorage.getItem("currentBooking");
    if (stored) {
        currentBooking = JSON.parse(stored);
    } else {
        currentBooking = {
            tickets: {},
            combos: {}
        };
    }
    
    // ä½¿ç”¨ Step1 é¸çš„é›»å½±è³‡è¨Š
    cinemaNameDisplay.textContent = currentBooking.cinemaName || "è¼‰å…¥ä¸­...";
    movieTitleDisplay.textContent = currentBooking.movieTitle || "è¼‰å…¥ä¸­...";
    showtimeDetailDisplay.textContent = currentBooking.showtimeDetail || "è¼‰å…¥ä¸­...";

    // ç¸½ç¥¨æ•¸
    totalTickets = currentBooking.totalTicketQty || 0;
    requiredTicketsSpan.textContent = totalTickets;
    totalTicketsRequiredSpan.textContent = totalTickets;

    // ç¥¨ç¨®æ‘˜è¦
    const tickets = currentBooking.tickets || {};
    const ticketEntries = Object.values(tickets);
    ticketsSummary.textContent = ticketEntries.length
        ? "ç¥¨ç¨®èˆ‡æ•¸é‡ï¼š" + ticketEntries.map(t => `${t.name} x ${t.qty}`).join(" + ")
        : "ç¥¨ç¨®èˆ‡æ•¸é‡ï¼šç„¡";

    // é¤é»æ‘˜è¦
    const combos = currentBooking.combos || {};
    const comboEntries = Object.values(combos);
    foodSummary.textContent = comboEntries.length && comboEntries.some(c => c.qty > 0)
        ? "é¤é»ï¼š" + comboEntries.filter(c => c.qty > 0).map(c => `${c.name} x ${c.qty}`).join(" + ")
        : "é¤é»ï¼šç„¡";

    renderSeatMap();
}



    function renderSeatMap() {
        const seatMap = document.getElementById("seatMap");
        seatMap.innerHTML = "";

        seatData.forEach((row, rIndex) => {
            const rowDiv = document.createElement("div");
            rowDiv.className = "flex space-x-2 items-center";

            const label = document.createElement("span");
            label.textContent = rows[rIndex];
            label.className = "font-bold w-4";
            rowDiv.appendChild(label);

            row.forEach((seat, cIndex) => {
                const seatId = `${rows[rIndex]}${cIndex+1}`;
                const seatDiv = document.createElement("div");
                seatDiv.textContent = cIndex + 1;
                seatDiv.classList.add("seat");

                if (seat === "O") {
                    seatDiv.classList.add("occupied");
                } else {
                    seatDiv.classList.add("available");
                    seatDiv.addEventListener("click", () => toggleSeat(seatId, seatDiv));
                }

                rowDiv.appendChild(seatDiv);
            });

            seatMap.appendChild(rowDiv);
        });
    }

    function toggleSeat(seatId, element) {
        if (element.classList.contains("occupied")) return;

        if (element.classList.contains("selected")) {
            element.classList.remove("selected");
            element.classList.add("available");
            selectedSeats = selectedSeats.filter(s => s !== seatId);
        } else {
            if (selectedSeats.length === totalTickets) {
                errorMessage.textContent = `æœ€å¤šåªèƒ½é¸ ${totalTickets} å€‹åº§ä½`;
                return;
            }
            element.classList.remove("available");
            element.classList.add("selected");
            selectedSeats.push(seatId);
        }

        errorMessage.textContent = "";
        updateSelectedDisplay();
    }

    function updateSelectedDisplay() {
        if (selectedSeats.length === 0) {
            selectedSeatsDisplay.textContent = "ç„¡";
            selectedSeatsSummary.textContent = "ç„¡";
        } else {
            selectedSeatsDisplay.textContent = selectedSeats.join("ã€");
            selectedSeatsSummary.textContent = selectedSeats.join("ã€");
        }

        submitSeatsInput.value = selectedSeats.join(",");

        nextButton.disabled = selectedSeats.length !== totalTickets;
    }

    // æäº¤
    document.getElementById("bookingFlow3Form").addEventListener("submit", function(e){
        e.preventDefault();

        if (selectedSeats.length !== totalTickets) {
            errorMessage.textContent = "è«‹å…ˆé¸æ»¿åº§ä½æ•¸é‡";
            return;
        }

        currentBooking.selectedSeats = selectedSeats;

        currentBooking.ticket_general = currentBooking.ticket_general || 0;
        currentBooking.ticket_student = currentBooking.ticket_student || 0;

        currentBooking.food_popcorn = currentBooking.food_popcorn || 0;
        currentBooking.food_drink = currentBooking.food_drink || 0;

        // ä¾†æºè³‡æ–™å¦‚æœä¾†è‡ª Step1~2ï¼Œå¯ä¸æ”¹
        currentBooking.cinemaId = currentBooking.cinemaId || 1;
        currentBooking.movieId = currentBooking.movieId || 1;
        currentBooking.showtimeId = currentBooking.showtimeId || 1;

        /** ğŸ”¥ æœ€çµ‚å„²å­˜ */
        localStorage.setItem("currentBooking", JSON.stringify(currentBooking));

        /** å‰å¾€ Step4 */
        window.location.href = "booking_flow_4.html";
    });

    window.onload = loadBookingData;
</script>

    <footer class="bg-gray-800 text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>
    

</body>
</html>
